<!DOCTYPE html>
<html>
  <head>
    <title>PointerCapture for Custome Shadow DOM</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="help" href= "https://bugs.chromium.org/p/chromium/issues/detail?id=810882">
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
    <script src="/resources/testdriver.js"></script>
    <script src="/resources/testdriver-actions.js"></script>
    <script src="/resources/testdriver-vendor.js"></script>
    <script>
       class WC extends HTMLElement{
        constructor(){
          super();
          let template = document.getElementById('template-wc');
          let node = template.content.cloneNode(true) ;

          let shadowRoot = this.attachShadow({mode: 'open'});
          shadowRoot.appendChild(node);
        }
       }
       customElements.define("wc-wc", WC);
    </script>
    </head>
  <body onload="onLoad()">
    <template id="template-wc">
      <style>
          #content{
              height:50px;
              width:50px;
              background-color: magenta;
          }
      </style>
      <div id="content"></div>
    </template>
    <h4>PointerCapture by Custom Element's Shadow DOM</h4>
      The magenta box below is part of a custom element's Shadow DOM.
    <ul>
      <li> Click left mouse button inside the box and keep mouse button depressed
      <li> Move the mouse
      <li> There should be a message stating <em>Pointer was captured by custom element's Shadow DOM!</em>
      <li> Release left mouse button
      <li> There should be a message stating <em>Pointer was released by custom element's Shadow DOM!</em>
    </ul>

    <wc-wc id="wc-wc"></wc-wc>
    <div id="log"></div>
    <script>
      var logDiv = document.getElementById("log");
      function logMessage(message){
        var log = document.createElement("div");
        var messageNode = document.createTextNode(message);
        log.appendChild(messageNode);
        logDiv.appendChild(log);
      }
      var events = [];

      var content_wc = document.getElementById("wc-wc")
         .shadowRoot.getElementById("content");

      content_wc.addEventListener("pointerdown", function(e){
        content_wc.setPointerCapture(e.pointerId);
        events.push("pointerdown@content_wc");
      });
      content_wc.addEventListener("gotpointercapture", function(e){
        logMessage("Pointer was captured by custom element's Shadow DOM!");
        events.push("gotpointercapture@content_wc");
      });
      content_wc.addEventListener("pointerup", function(e){
        content_wc.releasePointerCapture(e.pointerId);
        events.push("pointerup@content_wc");
      });
      content_wc.addEventListener("lostpointercapture", function(e){
        logMessage("Pointer was released by custom element's Shadow DOM!");
        events.push("lostpointercapture@content_wc");
        if(window.promise_test && wc_shadow_dom_test){
          wc_shadow_dom_test.step(function(){
            assert_array_equals(events, ["pointerdown@content_wc",
              "gotpointercapture@content_wc", "pointerup@content_wc",
              "lostpointercapture@content_wc"]);
            resolve_test();
            wc_shadow_dom_test.done();
          });
        }
      });

      var wc_shadow_dom_test = null;
      var resolve_test = null;
      var reject_test = null;

      function cleanup(){
        events = [];
        shadow_dom_test = null;
        resolve_test = null;
        reject_test = null;
      }

      function onLoad(){
        if(window.promise_test){
          promise_test(function(t){
            return new Promise(function(resolve, reject){
              wc_shadow_dom_test = t;
              resolve_test = resolve;
              reject_test = reject;
              t.add_cleanup(function(){
                cleanup();
              });
              var contentRect = content_wc.getBoundingClientRect();
              var actions = new test_driver.Actions();
              var actions_promise = actions
                  .pointerMove(contentRect.x, contentRect.y)
                  .pointerDown({button: actions.ButtonType.LEFT})
                  .pointerUp({button: actions.ButtonType.LEFT})
                  .send();
            });
          }, "PointerCapture works for custom element Shadow DOM.");
        }
      }
    </script>
  </body>
</html>
